define(["jquery","jqScrollto"],function(){var a=null,b=null,c=function(c,d,e){var f=this,g=!0,d=d,h=2*d,i=d,j=h,k=[],l=1.4;f.treeCmp=c,f.timer=null,f.pageNodeId=!1,f.silentClick=!1,f.loadingAll=!1,f.loadedAll=!1,f.isLoading=!1,f.initialised=!1,f.container=f.treeCmp.closest(".hierarchy-container"),f.scrollDuration=0,f.scrollDurationDefault=2400,f.topPanel=e.find(".hierarchy-top-panel"),f.bottomPanel=e.find(".hierarchy-bottom-panel");var m=!0,n=500,o=function(){var a=this;return a.timerId=0,a.secondsElapsed=0,a.secondElapsed=function(){a.secondsElapsed++;var b="",c="";"undefined"!=typeof waitMessages&&$.each(waitMessages,function(d,e){a.secondsElapsed>e.time&&(b=e.msg),a.secondsElapsed+2>e.time&&(c=e.msg)});var d=$(".wait-msg").html();c!=d&&($(".wait-msg").removeClass("opaque"),$(".wait-msg").addClass("transparent")),b!=d&&($(".wait-msg").removeClass("transparent"),$(".wait-msg").addClass("opaque")),$(".wait-msg").html(b.length?b:"")},a.start=function(){a.secondsElapsed=0,$(".wait-msg").html("");try{window.clearInterval(a.timerId)}catch(b){}a.timerId=window.setInterval(a.secondElapsed,1e3)},a.stop=function(){q("STOP TIMER"),window.clearInterval(a.timerId)},{start:function(){a.start()},stop:function(){a.stop()}}},p=function(){$(".jstree-node.ul").prev(".jstree-node.ol").removeClass("ol").addClass("ol-ul");for(var a=0;a<k.length;a++)$("#"+k[a]).addClass("parent-of-ul-first")},q=function(a){},r=function(a){return a.replace(/\//g,"_").replace(/-/g,"_")},s=function(a,c){var d=null,e=function(a,c,d,e,f,g,h){var i=c.def[0],j="undefined"==typeof e||0==e?"":"<span> ("+e+")<span>";i="undefined"!=typeof hierarchyOriginalUrl&&a==hierarchyOriginalUrl?(g&&h?f+". ":"")+i+j:(g?f+". ":"")+'<a href="'+b+a+'.html" onclick="var e = arguments[0] || window.event; followLink(e);">'+i+"</a>"+j,window.followLink=function(a){a.stopPropagation()};var k="";return"TEXT"==d&&(k='<svg class="icon icon-newspaper"><use xlink:href="#icon-newspaper"/></svg>'),"<span>"+i+" "+k+"</span>"};if("self.json"===a.action)d={id:r(a.self.id),text:e(a.self.id,a.self.title,a.self.type,a.self.childrenCount,a.self.index,a.self.parent,a.self.relBefore),data:{id:a.self.id,index:a.self.index,hasChildren:a.self.hasChildren,parent:a.self.parent,relBefore:a.self.relBefore}},d.data.hasChildren&&(d.data.childrenCount=a.self.childrenCount);else{var f=c?c.self.id:null;d={id:r(a.id),text:e(a.id,a.title,a.type,a.childrenCount,a.index,f,a.relBefore),data:{id:a.id,index:a.index,hasChildren:a.hasChildren,parent:f,relBefore:a.relBefore}},d.data.hasChildren&&(d.data.childrenCount=a.childrenCount)}return d},t=function(a,b){q("loadData"+a),$.getJSON(a,null,function(a){b(a)}).fail(function(b){q("failed to load data ("+JSON.stringify(b)+") from url: "+a)})},u=function(){return f.treeCmp.find(">ul>li:first-child")},v=function(a){var b=$(".loadPoint");if(!b.length)return!1;b=b.attr("id");var c=0,d=0,e=function(g,h){return h=h?h:0,$.each(g.children,function(g,i){h++;var j=f.treeCmp.jstree("get_node",i);j.id==b&&(c=h),j==a&&(d=h),j.state.opened&&(h=e(j,h))}),h};return e(f.treeCmp.jstree("get_node",u().attr("id"))),[c,d]},w=function(a){q("fakeChildNodes"),x(a);for(var b=0;b<a.children.length;b++)w(f.treeCmp.jstree("get_node",a.children[b]))},x=function(a){a.data&&a.data.hasChildren&&(!a.children||a.children&&0==a.children.length)&&f.treeCmp.jstree("create_node",a,{id:a.id+"_DUMMY_CHILD",text:"X",data:{id:a.id+"_DUMMY_CHILD",index:1,parent:a.id}},"first",!1,!1)},y=function(b,c){if(!b.data||!b.data.hasChildren||b.children&&b.children.length)c&&(q("loadFirstChild takes no action\n	node.data "+b.id+"\n	node.has  "+b.data.hasChildren+"\n	node.children[0] "+(b.children?JSON.stringify(b.children[0],null,4):"(none)")),c());else{var d=a+b.data.id+"/hierarchy/children.json?limit=1";t(d,function(d){var e=d.children[0];childUrl=a+e.id+"/hierarchy/self.json",t(childUrl,function(a){var d=f.treeCmp.jstree("create_node",b,s(a),"first",!1,!0),e=f.treeCmp.jstree("get_node",d);q("add override here?"),0==e.data.relBefore&&(q("add override here "+b.id),k.push(r(b.id))),c(e)})})}},z=function(b,c,d,e,g){if(null==b.parent||"string"!=typeof b.parent.toLowerCase())return q("node.parent = null: node is "+b.id+" (returning)"),void(g&&g());if(!c&&e){for(var h=b;h.children.length&&h.state.opened;)h=f.treeCmp.jstree("get_node",h.children[0]);for(var i=function(a){var b=f.treeCmp.jstree("get_node",a.parent);if(!b.data)return!1;var c=b.children.length,d=b.data.childrenCount;return c==d};i(h);)h=f.treeCmp.jstree("get_node",h.parent);b=h}var j=f.treeCmp.jstree("get_node",b.parent);if(b=f.treeCmp.jstree("get_node",c?j.children[0]:j.children[j.children.length-1]),"string"==(typeof b.parent).toLowerCase()){var j=f.treeCmp.jstree("get_node",b.parent);if(c){var k=0;if($.each(j.children,function(a,c){c==b.id&&(k=a)}),k>0){var l=f.treeCmp.jstree("get_node",j.children[k-1]);if(f.treeCmp.jstree("is_disabled",l)){var m=l.children[l.children.length-1];b=f.treeCmp.jstree("get_node",m),j=l}}}var n=function(){if(d>0){var a=f.treeCmp.jstree("get_node",b.parent,!1);"object"==typeof a.data?z(a,c,d,!1,g):(q("no more data"),g&&g())}else q("EXIT LOAD (leftToLoad hit zero)"),g&&g()};if(b.data.parent){var o=a+b.data.id+"/hierarchy/"+(c?"preceding":"following")+"-siblings.json?limit="+d;t(o,function(a){var e=a;a=a[(c?"preceding":"following")+"-siblings"],q(" - loaded "+typeof a),a&&a.length>0?$.each(a,function(h,i){var k=f.treeCmp.jstree("create_node",j,s(i,e),c?"first":"last",!1,!0),l=f.treeCmp.jstree("get_node",k);x(l),h+1==a.length&&(d-=a.length,d>0?z(b,c,d,!0,g):g&&g())}):c?(f.treeCmp.jstree("is_disabled",j)&&(f.treeCmp.jstree("enable_node",j),d--),d>0?z(j,c,d,!0,g):g&&g()):n()})}else n()}else q("no parent")},A=function(){f.container.prev(".ajax-overlay").length||f.container.before('<div class="ajax-overlay"><span class="wait-msg"></span></div>'),f.container.prev(".ajax-overlay").show(),$("<style></style>").appendTo($(document.body)).remove()},B=function(){f.initialised&&(f.container.prev(".ajax-overlay").hide(),$("<style></style>").appendTo($(document.body)).remove())},C=function(a){var b=window.location.href.indexOf("?")?window.location.href.split("?")[0]:window.location.href;window.location.href=b+"?"+$(a).attr("href")},D=function(){f.topPanel.find(".top-arrows").remove();var a=$('<div class="top-arrows"></div>').appendTo(f.topPanel),b=I(),c=b[0],d=1,e=c.data.index,g=$("#"+c.id).hasClass("ul"),h=!1;for("#"!=c.id&&$("#"+c.id).hasClass("jstree-open")&&(h=!0),$("#"+c.id).hasClass("jstree-last")&&(h=!0);c.parent;)if(e=c.data.index,c=f.treeCmp.jstree("get_node",c.parent),"#"!=c.id){var i=c.data.childrenCount;if($("#"+c.id+" > .jstree-children").length||$("#"+c.id).hasClass("jstree-last")){d++;var j=e==i?"arrow-spacer":g?"arrow top-ul":"arrow top";h&&(j=g?"arrow top-ul":"arrow top",h=!1),a.append('<div title="'+g+'" class="'+j+'" style="right:'+d+'em">'),a.css("width",d+"em"),$(".hierarchy-prev").css("margin-left",d+2+"em")}g=$("#"+c.id).hasClass("ul")}E(b)},E=function(a){f.bottomPanel.find(".bottom-arrows").remove();var b=function(a){for(var b=$("#"+a.id).next();0==b.length;){var c=$("#"+a.id).parent().closest("li");if(0==c.length)break;a=c,b=c.next()}return b},c=$('<div class="bottom-arrows"></div>').prependTo(f.bottomPanel),d=a[1],e=2,g=b(d).hasClass("ul");if("#"!=d.id&&$("#"+d.id).hasClass("jstree-open")){var h=$("#"+d.id).hasClass("ul")?"arrow bottom-ul":"arrow bottom",i='<div title="'+g+" "+$("#"+a[1].id).hasClass("ul")+'" class="'+h+'" style="right:'+e+'em">';e++,c.append(i),c.css("width",e+"em")}for(;d.parent;){var j=d.data.index;if(d=f.treeCmp.jstree("get_node",d.parent),"#"!=d.id){var k=d.data.hasChildren?d.data.childrenCount:0;if($("#"+d.id+" > .jstree-children").length){e++;var h=j==k?"arrow-spacer":g?"arrow bottom-ul":"arrow bottom",i='<div title="'+g+'" class="'+h+'" style="right:'+e+'em">';c.append(i),c.css("width",e+"em"),$(".hierarchy-next").css("margin-left",e+1+"em")}g=b(d).hasClass("ul")}}},F=function(){D();var a=f.container.scrollTop();f.container.scrollTop()>1?($(".hierarchy-prev").addClass("show"),$(".hierarchy-top-panel").removeClass("top")):($(".hierarchy-prev").removeClass("show"),$(".hierarchy-top-panel").addClass("top"));var b=f.container.height(),c=f.treeCmp.height();c-a>b?$(".hierarchy-next").addClass("show"):$(".hierarchy-next").removeClass("show")},G=function(a,b){return p(),"undefined"==typeof a?void q("doScrollTo error - undefined @el"):(f.container.css("overflow","auto"),f.container.scrollTo(a,f.scrollDuration,{axis:"y",onAfter:function(){return b?(m&&f.container.css("overflow","hidden"),void b()):void 0}}),void(m&&f.container.css("overflow","hidden")))},H=function(a,b,c,d){if(!f.isLoading){f.isLoading=!0,f.loadingAll||f.timer.start(),$(".top-arrows").add($(".bottom-arrows")).addClass("transparent");var e=$(".jstree-container-ul .jstree-disabled").length,g=(parseInt(f.container.scrollTop()),I()),i=c?g[0]==c||c.state.disabled:!1,j=g[0].id;A(),z(a,b,h,!0,function(){var g=f.container.height(),h=$(".jstree-container-ul .jstree-disabled").length,k=function(){var a=h!=e,c=I()[2].id,d=$("#"+c+">a");return b&&a?(f.silentClick=!0,d.click(),f.scrollDuration=0,G("#"+c,function(){f.scrollDuration=f.scrollDurationDefault,B(),d.focus()}),!0):void(b&&d.focus())};if(c)f.scrollDuration=0,G("#"+j),f.scrollDuration=f.scrollDurationDefault,i?k():$("#"+a.id+">a").focus(),B(),d&&(f.isLoading=!1,f.loadingAll||f.timer.stop(),d());else{var l=function(){var c=f.container.scrollTop(),e=c,h=I();a==h[0]?(b?e-=g:e+=g,e=Math.max(0,e),!b&&f.container.height()<e&&(e="#"+h[1].id)):q("ERROR CODE 1\n\nIf you see this please record the what steps were needed to produce this error and what browser was used, and let Andy know about it\n\ninitiatingNode != visibleNodes[0]\n\ninitiator was "+a.id),B(),G(e,function(){f.scrollDuration=0,setTimeout(function(){G("#"+I()[0].id,function(){f.scrollDuration=f.scrollDurationDefault,F(),f.loadingAll||f.timer.stop(),f.isLoading=!1,d&&d()})},1)})};f.scrollDuration=0,G("#"+j),f.scrollDuration=f.scrollDurationDefault,l()}})}};$(".load-more").click(function(){console.error("hierarchy: no handler")}),$(".view-next").click(function(){console.error("hierarchy: no handler")}),$(".hierarchy-prev>a").click(function(){H(I()[0],!0,!1,function(){})}),$(".hierarchy-next>a").click(function(){H(I()[0],!1,!1,function(){})});var I=function(){var a=$(".ajax-overlay").is(":visible");a&&B();var b=null,c=null,d=null,e=f.bottomPanel[0].getBoundingClientRect().top,g=f.topPanel[0].getBoundingClientRect().bottom;return $(".jstree-anchor").not(".jstree-disabled").each(function(a,d){var f=d.getBoundingClientRect().top+5;return!b&&f>=g&&(b=d),f>e?!1:void(c=d)}),c=$(c).closest("li.jstree-node"),b=$(b).closest("li.jstree-node"),d=b.prevAll("li.jstree-node:first"),d.length||(d=b.closest("li.jstree-node")),d.length||(d=b),a&&A(),[f.treeCmp.jstree("get_node",b.attr("id")),f.treeCmp.jstree("get_node",c.attr("id")),f.treeCmp.jstree("get_node",d.attr("id"))]},J=function(){f.initialised=!0,f.container.removeClass("uninitialised"),f.topPanel.removeClass("uninitialised"),h=i},K=function(b,c,i){g=i,f.timer=new o;var m=function(){if(!f.loadedAll){var a=navigator.userAgent.match(/Trident/)||navigator.userAgent.match(/MSIE/);a&&f.container.css("margin-left","1em"),navigator.userAgent.match(/Chrome/i)||navigator.userAgent.match(/Opera/i)||navigator.userAgent.match(/Safari/i)?f.container.css({height:d*l-.4+"em","max-height":d*l-.4+"em"}):f.container.css({height:d*l+"em","max-height":d*l+"em"}),f.treeCmp.css("padding-bottom",d*l+"em");var b=f.container.outerHeight(!0);f.container.css({height:b+"px","max-height":b+"px"})}},n=document.documentElement.clientWidth/window.innerWidth;$(window).resize(function(){var a=document.documentElement.clientWidth/window.innerWidth;n!=a&&(n=a,m(),G("#"+I()[0].id,function(){F()}))}),m();var C=function(a){$(".loadPoint").removeClass("loadPoint"),$("#"+a).addClass("loadPoint")},D=function(a,b){f.isLoading=!0,A(),f.loadingAll||f.timer.start();var c=function(){G($("#"+a.id),function(){F(),C(a.id),$("#"+a.id+">a").focus(),b&&b(),f.isLoading=!1,f.loadingAll||f.timer.stop(),B()})};j>0?z(a,!1,j,!0,function(){c()}):c()};f.treeCmp.bind("select_node.jstree",function(a,b){g&&($(".debug-area").html(JSON.stringify(b.node,null,2)),f.silentClick||f.loadedAll||D(b.node)),f.silentClick=!1}),f.treeCmp.bind("create_node.jstree",function(a,b){node=f.treeCmp.jstree("get_node",b.node.id),node.data.relBefore?node.li_attr["class"]="ol":(p(),node.li_attr["class"]="ul",$("#"+node.id).addClass("ul"))}),f.treeCmp.bind("loaded.jstree",function(a,b){setTimeout(function(){var a=f.treeCmp.jstree("get_node",f.pageNodeId);D(a,function(){setTimeout(function(){var a=f.treeCmp.jstree("get_node",f.pageNodeId);q("loaded.tree lfc"),y(a,function(){f.treeCmp.jstree("disable_node",a.parent),C(f.pageNodeId),f.scrollDuration=f.scrollDurationDefault;var b=f.treeCmp.jstree("get_node",u().attr("id"));e.find(".hierarchy-title").html(u().find("span").html()),e.find(".hierarchy-title svg").remove(),f.pageNodeId==b.id?(e.find(".hierarchy-title a").wrapInner("<span/>"),e.find(".hierarchy-title a span").unwrap(),f.treeCmp.jstree("open_node",a)):(e.find(".hierarchy-title").contents().filter(function(){return 3==this.nodeType}).remove(),$("#"+f.pageNodeId+">a").focus(),J(),B(),$("#"+f.pageNodeId+">a").focus(),f.isLoading=!1,f.timer.stop(),setTimeout(function(){q("scroll to "+f.pageNodeId+" ("+$("#"+f.pageNodeId).length+")"),G("#"+f.pageNodeId)},800))})},1)})},1)}),f.treeCmp.bind("keydown.jstree",function(a){if(!(f.loadingAll||f.isLoading||40!=a.which&&38!=a.which)){if(a.ctrlKey||a.shiftKey){var b=function(){$("#"+I()[0].id+">a").focus()};return 38==a.which&&$(".hierarchy-prev").is(":visible")&&H(I()[0],!0,!1,function(){F(),b()}),void(40==a.which&&$(".hierarchy-next").is(":visible")&&H(I()[0],!1,!1,function(){F(),b()}))}var c,d=f.treeCmp.find(".jstree-hovered"),e=f.treeCmp.jstree("get_node",d.parent()),g=!1,i=38==a.which;if(d.hasClass("jstree-disabled"))g=!0,c=f.treeCmp.jstree("get_node",$(".loadPoint").attr("id"));else{var j=v(e);j=j?i?j.reverse():j:!1,(!j||j[0]>j[1]||j[1]-j[0]>h/2)&&(g=!0,c=e)}if(g){$(".jstree-container-ul .jstree-disabled").length;H(c,i,e,function(){C(c.id),F()})}else f.scrollDuration=0,G("#"+I()[0].id,function(){f.scrollDuration=f.scrollDurationDefault,F()})}}),f.treeCmp.on("open_node.jstree",function(a,b){if(f.loadingAll||f.isLoading)return void q("return because loading - open_node");var c=b.node,d=f.treeCmp.jstree("get_node",c.children[0]);q("openNode lfc "+d.id);var e=function(){f.initialised||(q("open_node handles onInit() call"),J()),C(c.id),B(),$("#"+c.id+">a").focus(),F(),p(),f.isLoading=!1,f.timer.stop(),f.initialised||J()};d.id.indexOf("DUMMY_CHILD")>-1?(q("load real data"),f.isLoading=!0,f.timer.start(),A(),f.treeCmp.jstree("delete_node",d),y(c,function(a){return a?(x(a),void z(a,!1,h,!0,function(){e()})):void console.warn("no new node loaded!")})):(q("non dummy opened"),x(d),z(d,!1,h,!0,function(){e()}))}),f.treeCmp.bind("close_node.jstree",function(a,b){f.loadingAll||(q("closed "+b.node.text),A(),z(b.node,!1,h,!0,function(){C(b.node.id),B(),p(),$("#"+b.node.id+">a").focus(),setTimeout(function(){F()},500)}))});var E=function(b,c,d){if(!b)return q("NO URL - exit"),void d(c);var g=function(b){var g=s(b);c?(g.state={opened:!0,disabled:!0},g.children=$.isArray(c)?c:[c],c=g):(c=g,f.pageNodeId=c.id);var h=!1;if($.isArray(g)&&g.length?(q("ERROR CODE 2"),h=c[0].data):h=c,h&&h.data&&h.data.parent&&"undefined"!=typeof h.data.index){var i=a+h.data.parent+"/hierarchy/self.json";E(i,c,d)}else e.find(".hierarchy-title").html(c.text.substr(c.text.indexOf(". ")+2,c.text.length)),e.find(".hierarchy-title svg").remove(),e.find(".hierarchy-title span").removeAttr("class"),e.find(".hierarchy-title a").removeAttr("onclick"),d(c)};"object"==typeof b?g(b):t(b,g)};if(c){var K=b,L=null,M=null;1!=K.self.index||K.self.relBefore||K.self.parent&&k.push(r(K.self.parent)),K.ancestors?($.each(K.ancestors.reverse(),function(a,b){pData=s(b,K),1!=pData.data.index||pData.data.relBefore||k.push(r(pData.data.id)),M?(M.state={opened:!0,disabled:!0},M.children=[pData],M=M.children[0]):(M=pData,L=M),M.data.childrenCount&&0!=M.data.childrenCount||console.error("Data error!\n\nAncestors are expected to have a children count greater than zero.\n\nThere is no number after the title in this hierarchy because of this missing data\n(and non-flat hierarchies will break):\n\n"+JSON.stringify(M,null,4))}),M.children=[],M.state={opened:!0},M.children.push(s(K.self,{self:{id:M.data.id}})),f.pageNodeId=M.children[M.children.length-1].id):(M=s(K.self),f.pageNodeId=M.id,L=M),K["preceding-siblings"]&&$.each(K["preceding-siblings"],function(a,b){M.children.unshift(s(b,{self:{id:M.data.id}}))}),K["following-siblings"]&&$.each(K["following-siblings"],function(a,b){M.children.push(s(b,{self:{id:M.data.id}})),j--});f.treeCmp.jstree({core:{data:L,check_callback:!0},plugins:["themes","json_data","ui"]});w(f.treeCmp.jstree("get_node",u().attr("id")));var N=function(a){a.data.relBefore?a.li_attr["class"]="ol":(a.li_attr["class"]="ul",$("#"+a.id).addClass("ul"));for(var b=0;b<a.children.length;b++)N(f.treeCmp.jstree("get_node",a.children[b]))};N(f.treeCmp.jstree("get_node",u().attr("id"))),setTimeout(function(){p()},1e3)}else E(b,!1,function(a){M=a,q("Initialise tree with model:\n\n"+JSON.stringify(M,null,2));f.treeCmp.jstree({core:{data:M,check_callback:!0},plugins:["themes","json_data","ui"]})})};return{init:function(a,b,c){K(a,b,c)},nodeLinkClick:function(a){C(a)},getContainer:function(){return f.container},getVisibleNodes:function(){return I()},getLocked:function(){return f.locked},getIsLoading:function(){return f.isLoading},setLocked:function(a){f.locked=a},brokenArrows:function(){D()},setDefaultDelay:function(a){n=a},startTimer:function(a){A(),f.timer.start()},stopTimer:function(a){B(),f.timer.stop()},scrollTop:function(a){a&&f.container.scrollTop(a)},getTree:function(){return f.treeCmp},getInitialised:function(){return f.initialised},getTreeData:function(){var a=f.treeCmp.jstree("get_node","0");return JSON.stringify(a)},addCustomClasses:function(){p()}}};return{create:function(d,e,f,g,h){return a=h?h:"",b=g,c(d,e,f)},init:function(a,b,c){init(c)}}});